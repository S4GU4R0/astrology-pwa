<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Astrological Chart Worksheet</title>
<link rel="stylesheet" href="css/ui-polish.css">
<script src="js/ui-helpers.js"></script>
<style>
    body {font-family:Arial,Helvetica,sans-serif;background:#f5f5f9;color:#222;margin:2rem;}
    h1 {margin-bottom:.5rem;}
    form {background:#fff;padding:2rem;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);}
    .field {margin-bottom:1rem;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;}
    .field label {flex:0 0 170px;font-weight:600;}
    .field input[type=text],
    .field input[type=number],
    .field input[type=date],
    .field input[type=time],
    .field select {flex:1 1 200px;padding:.4rem;border:1px solid #bbb;border-radius:4px;}
    .inline {display:flex;align-items:center;gap:.7rem;}
    .inline label {font-weight:normal;}
    .note {font-size:.85em;color:#555;}
    button {background:#0066cc;color:#fff;border:none;padding:.6rem 1.2rem;border-radius:4px;cursor:pointer;}
    button:hover {background:#004c99;}
    .planet {border:1px solid #e0e0e0;margin-top:1rem;padding:1rem;border-radius:6px;}
    .planet h3 {margin-top:0;}
    .subsection {margin-top:1rem;padding-top:.5rem;border-top:1px solid #ddd;}
    #results {background:#fff;padding:2rem;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin-top:2rem;display:none;}
    .result-planet {border:1px solid #e0e0e0;margin-top:1rem;padding:1rem;border-radius:6px;background:#f9f9f9;}
    .grade {font-size:2em;font-weight:bold;display:inline-block;padding:.5rem 1rem;border-radius:4px;margin:.5rem 0;}
    .grade-A {background:#4caf50;color:white;}
    .grade-B {background:#8bc34a;color:white;}
    .grade-C {background:#ffc107;color:#222;}
    .grade-D {background:#ff9800;color:white;}
    .grade-E {background:#ff5722;color:white;}
    .grade-F {background:#f44336;color:white;}
    .factors {margin-top:1rem;padding:1rem;background:#fff;border-left:3px solid #0066cc;}
    .factors li {margin-bottom:.3rem;}
</style>
</head>
<body>

<div style="margin-bottom:1rem;">
    <a href="index.html" style="text-decoration:none;color:#0066cc;">← Back to Chart</a>
</div>

<h1>Astrological Chart Worksheet</h1>

<form id="chartForm">

    <!-- ==================== 1. BIRTH DATA ==================== -->
    <div class="field">
        <label for="b_name">Name</label>
        <input type="text" id="b_name" name="birth[name]" required>
    </div>

    <div class="field">
        <label for="b_date">Date of Birth</label>
        <input type="date" id="b_date" name="birth[date]" required>
    </div>

    <div class="field">
        <label for="b_time">Time of Birth</label>
        <input type="time" id="b_time" name="birth[time]" required>
    </div>

    <div class="field">
        <label for="b_place">Place of Birth</label>
        <input type="text" id="b_place" name="birth[place]" required placeholder="City, Country">
    </div>

    <script src="js/error-handling.js"></script>
    <script>
    // Load persisted chart data from main app
    document.addEventListener('DOMContentLoaded', function() {
        try {
            const savedData = localStorage.getItem('astrodex_chart_data');
            if (savedData) {
                const data = JSON.parse(savedData);
                if (document.getElementById('b_name')) document.getElementById('b_name').value = data.name || '';
                if (document.getElementById('b_date')) document.getElementById('b_date').value = data.date || '';
                if (document.getElementById('b_time')) document.getElementById('b_time').value = data.time || '';
                if (document.getElementById('b_place')) document.getElementById('b_place').value = data.location || '';
            }
        } catch (error) {
            const errorMsg = handleStorageError(error);
            showError(errorMsg, 'warning');
            console.error('Error loading persisted chart data:', error);
        }
    });
    </script>

    <!-- ==================== 2. CHART SECT ==================== -->
    <div class="field">
        <label>Chart Sect (Diurnal / Nocturnal)</label>
        <div class="inline">
            <input type="radio" id="sect_day" name="chart_sect" value="day" required>
            <label for="sect_day">Day (Diurnal)</label>
            <input type="radio" id="sect_night" name="chart_sect" value="night">
            <label for="sect_night">Night (Nocturnal)</label>
        </div>
    </div>

    <!-- ==================== PLANET BLOCKS ==================== -->
    <div id="planetsContainer"></div>

    <!-- ==================== SUBMIT ==================== -->
    <div style="margin-top:2rem;">
        <button type="submit">Calculate Planetary Conditions</button>
    </div>
</form>

<!-- ==================== RESULTS SECTION ==================== -->
<div id="results">
    <h2>Planetary Evaluation Results</h2>
    <div id="resultsContent"></div>
</div>

<script>
/* ----------------------------------------------------
   DATA THAT DRIVES THE FORM
   ---------------------------------------------------- */
const planets = [
    { name:"Sun",     rejoicing:["sign"] },
    { name:"Moon",    rejoicing:["hemisphere","sign"] },
    { name:"Mercury", rejoicing:["hemisphere","sign"] },
    { name:"Venus",   rejoicing:["hemisphere","sign","solar_phase"] },
    { name:"Mars",    rejoicing:["hemisphere","sign","solar_phase"] },
    { name:"Jupiter", rejoicing:["hemisphere","sign","solar_phase"] },
    { name:"Saturn",  rejoicing:["hemisphere","sign","solar_phase"] }
];

const signs = ["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra",
               "Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
const natures      = ["Benefic","Malefic","Common","Luminary"];
const sects        = ["Day","Night"];
const dignityOpts  = ["Domicile","Exaltation","Detriment","Fall","Mutual Reception"];
const solarPhases  = ["Morning Star","Evening Star","None"];
const fastSlow     = ["Fast","Slow"];
const directRetro  = ["Direct","Retrograde"];
const visibility   = ["Visible (>150°)","Under Beams (<150°)"];
const chariotOpts  = ["Domicile","Exaltation","Triplicity","Bound"];
const phaseTrans   = [
    {id:"heliacal_morn_rise",  label:"Heliacal Morning Rising (Mercury/Venus)"},
    {id:"heliacal_morn_set",   label:"Heliacal Morning Setting (Mercury/Venus)"},
    {id:"heliacal_eve_rise",   label:"Heliacal Evening Rising (Mercury/Venus)"},
    {id:"heliacal_eve_set",    label:"Heliacal Evening Setting (Mercury/Venus)"},
    {id:"station",              label:"Direct/Retrograde station ±7 days"}
];
const testimonyOpts = [
    {key:"favorable",   label:"Favorable testimony (Conj/ sextile/ trine from Venus or Jupiter)"},
    {key:"unfavorable", label:"Unfavorable testimony (Conj/ square/ opposition from Saturn or Mars)"}
];
const superiority = ["Superior (stronger)","Inferior (weaker)"];
const maltOrBoni   = ["Maltreated","Bonified"];
const lordCond     = ["Helped (good house)","Hindered (bad house)"];
const aversionMit  = "Aversion mitigated by sign sympathy";

/* ----------------------------------------------------
   BUILD THE FORM
   ---------------------------------------------------- */
const container = document.getElementById('planetsContainer');

planets.forEach(p => {
    const sec = document.createElement('section');
    sec.className = "planet";

    /* ---- Header ---- */
    sec.innerHTML = `<h3>${p.name}</h3>`;

    /* ---- Sign & Degree ---- */
    sec.innerHTML += `
    <div class="field">
        <label for="${p.name}_sign">Sign</label>
        <select id="${p.name}_sign" name="${p.name}[sign]" required>
            <option value="">--Select Sign--</option>
            ${signs.map(s=>`<option value="${s}">${s}</option>`).join('')}
        </select>

        <label for="${p.name}_deg">Degree (0‑29°)</label>
        <input type="number" id="${p.name}_deg" name="${p.name}[deg]" min="0" max="29" required>
    </div>`;

    /* ---- Nature ---- */
    sec.innerHTML += `
    <div class="field">
        <label for="${p.name}_nature">Nature</label>
        <select id="${p.name}_nature" name="${p.name}[nature]" required>
            <option value="">--Select Nature--</option>
            ${natures.map(n=>`<option value="${n}">${n}</option>`).join('')}
        </select>
    </div>`;

    /* ---- Planet Sect ---- */
    sec.innerHTML += `
    <div class="field">
        <label>Planet Sect</label>
        <div class="inline">
            <input type="radio" id="${p.name}_sect_day" name="${p.name}[sect]" value="Day" required>
            <label for="${p.name}_sect_day">Day</label>
            <input type="radio" id="${p.name}_sect_night" name="${p.name}[sect]" value="Night">
            <label for="${p.name}_sect_night">Night</label>
        </div>
    </div>`;

    /* ---- Relation to chart sect ---- */
    sec.innerHTML += `
    <div class="field">
        <label>Relation to Chart Sect</label>
        <div class="inline">
            <input type="radio" id="${p.name}_rel_same" name="${p.name}[rel_sect]" value="same" required>
            <label for="${p.name}_rel_same">Same</label>
            <input type="radio" id="${p.name}_rel_contrary" name="${p.name}[rel_sect]" value="contrary">
            <label for="${p.name}_rel_contrary">Contrary</label>
        </div>
    </div>`;

    /* ---- Sect‑Rejoicing ---- */
    sec.innerHTML += `
    <div class="field">
        <label>Sect‑Rejoicing</label>
        <div class="inline">
            ${p.rejoicing.includes('hemisphere')
                ? `<input type="checkbox" id="${p.name}_rejoy_hem" name="${p.name}[rejoicing][]" value="hemisphere">
                   <label for="${p.name}_rejoy_hem">Hemisphere</label>` : ''}

            ${p.rejoicing.includes('sign')
                ? `<input type="checkbox" id="${p.name}_rejoy_sign" name="${p.name}[rejoicing][]" value="sign">
                   <label for="${p.name}_rejoy_sign">Sign</label>` : ''}

            ${p.rejoicing.includes('solar_phase')
                ? `<input type="checkbox" id="${p.name}_rejoy_phase" name="${p.name}[rejoicing][]" value="solar_phase">
                   <label for="${p.name}_rejoy_phase">Solar Phase</label>` : ''}
        </div>
        <div class="note">(${p.rejoicing.length} possible ${p.rejoicing.length===1?'condition':'conditions'} for ${p.name})</div>
    </div>`;

    /* ---- Lords ---- */
    sec.innerHTML += `
    <div class="field">
        <label for="${p.name}_domicile">Domicile Lord</label>
        <input type="text" id="${p.name}_domicile" name="${p.name}[lords][domicile]" placeholder="e.g., Aries">

        <label for="${p.name}_exalt">Exaltation Lord</label>
        <input type="text" id="${p.name}_exalt" name="${p.name}[lords][exaltation]" placeholder="e.g., Taurus">

        <label for="${p.name}_trip">Triplicity Lord</label>
        <input type="text" id="${p.name}_trip" name="${p.name}[lords][triplicity]" placeholder="e.g., Gemini">

        <label for="${p.name}_bound">Bound Lord (rounded up)</label>
        <input type="text" id="${p.name}_bound" name="${p.name}[lords][bound]" placeholder="e.g., Cancer">
    </div>`;

    /* ---- Dignities / Mutual Reception ---- */
    sec.innerHTML += `
    <div class="field">
        <label>Dignities / Mutual Reception</label>
        ${dignityOpts.map(d=>`
            <div class="inline">
                <input type="checkbox" id="${p.name}_dign_${d.toLowerCase().replace(/ /g,'_')}"
                       name="${p.name}[dignity][]" value="${d}">
                <label for="${p.name}_dign_${d.toLowerCase().replace(/ /g,'_')}">${d}</label>
            </div>`).join('')}
    </div>`;

    /* =========================================================
       6. Solar Phase
       ========================================================= */
    sec.innerHTML += `<div class="subsection"><h4>6. Solar Phase</h4>`;

    /* 6‑1 Fast / Slow */
    sec.innerHTML += `
    <div class="field">
        <label>Speed</label>
        <div class="inline">
            ${fastSlow.map(v=>`
                <input type="radio" id="${p.name}_speed_${v.toLowerCase()}" name="${p.name}[solar][speed]" value="${v}" required>
                <label for="${p.name}_speed_${v.toLowerCase()}">${v}</label>`).join('')}
        </div>
    </div>`;

    /* 6‑2 Direct / Retrograde */
    sec.innerHTML += `
    <div class="field">
        <label>Direction</label>
        <div class="inline">
            ${directRetro.map(v=>`
                <input type="radio" id="${p.name}_dir_${v.toLowerCase()}" name="${p.name}[solar][direction]" value="${v}" required>
                <label for="${p.name}_dir_${v.toLowerCase()}">${v}</label>`).join('')}
        </div>
    </div>`;

    /* 6‑3 Visibility */
    sec.innerHTML += `
    <div class="field">
        <label>Visibility</label>
        <div class="inline">
            ${visibility.map(v=>`
                <input type="radio" id="${p.name}_vis_${v.split(' ')[0].toLowerCase()}" name="${p.name}[solar][visibility]" value="${v}" required>
                <label for="${p.name}_vis_${v.split(' ')[0].toLowerCase()}">${v}</label>`).join('')}
        </div>
    </div>`;

    /* 6‑4 If under the beams → chariot & cazimi */
    sec.innerHTML += `
    <div class="field">
        <label>Chariot (when under beams)</label>
        ${chariotOpts.map(o=>`
            <div class="inline">
                <input type="checkbox" id="${p.name}_chariot_${o.toLowerCase()}"
                       name="${p.name}[solar][chariot][]" value="${o}">
                <label for="${p.name}_chariot_${o.toLowerCase()}">${o}</label>
            </div>`).join('')}
    </div>
    <div class="field">
        <label for="${p.name}_cazimi">Cazimi (under beams & within 1°)</label>
        <input type="checkbox" id="${p.name}_cazimi" name="${p.name}[solar][cazimi]" value="cazimi">
    </div>`;

    /* 6‑5 Phase (morning/evening star) */
    sec.innerHTML += `
    <div class="field">
        <label>Phase (morning/evening star)</label>
        <select name="${p.name}[solar][phase]" required>
            <option value="">--Select Phase--</option>
            ${solarPhases.map(v=>`<option value="${v.toLowerCase().replace(' ','_')}">${v}</option>`).join('')}
        </select>
    </div>`;

    /* 6‑6 Phase‑transition (phasis) */
    sec.innerHTML += `
    <div class="field">
        <label>Phase Transition (phasis)</label>
        ${phaseTrans.map(o=>`
            <div class="inline">
                <input type="checkbox"
                       id="${p.name}_phasis_${o.id}"
                       name="${p.name}[solar][phasis][]" value="${o.id}">
                <label for="${p.name}_phasis_${o.id}">${o.label}</label>
            </div>`).join('')}
    </div>`;

    sec.innerHTML += `</div>`; /* end of Solar Phase subsection */

    /* =========================================================
       7. Lunar Aspects
       ========================================================= */
    sec.innerHTML += `<div class="subsection"><h4>7. Lunar Aspects</h4>`;
    sec.innerHTML += `
    <div class="field">
        <label for="${p.name}_moon_applying">Moon applying aspect to this planet</label>
        <input type="checkbox" id="${p.name}_moon_applying" name="${p.name}[lunar][moon_applying]" value="yes">
    </div>
    <div class="field">
        <label for="${p.name}_conj_node">Planet conjunct one of the Nodes</label>
        <input type="checkbox" id="${p.name}_conj_node" name="${p.name}[lunar][conj_node]" value="yes">
    </div>`;
    sec.innerHTML += `</div>`; /* end of Lunar Aspects */

    /* =========================================================
       8. Aspect Testimony
       ========================================================= */
    sec.innerHTML += `<div class="subsection"><h4>8. Aspect Testimony</h4>`;

    testimonyOpts.forEach(t => {
        sec.innerHTML += `
        <div class="field">
            <label>${t.label}</label>
            <div class="inline">
                <input type="checkbox" id="${p.name}_testimony_${t.key}" name="${p.name}[testimony][${t.key}]" value="yes">
                <label for="${p.name}_testimony_${t.key}">Present</label>
            </div>
            <div class="inline">
                <label>Strength</label>
                ${superiority.map(s=>`
                    <input type="radio" name="${p.name}[testimony][${t.key}_strength]" value="${s.toLowerCase()}" ${s==='Superior (stronger)' ? 'required' : ''}>
                    <label>${s}</label>`).join('')}
            </div>
        </div>`;
    });

    /* Maltreated / Bonified */
    sec.innerHTML += `
    <div class="field">
        <label>Planet condition</label>
        ${maltOrBoni.map(v=>`
            <div class="inline">
                <input type="radio" id="${p.name}_cond_${v.toLowerCase()}" name="${p.name}[condition]" value="${v}" required>
                <label for="${p.name}_cond_${v.toLowerCase()}">${v}</label>
            </div>`).join('')}
    </div>`;

    sec.innerHTML += `</div>`; /* end of Aspect Testimony */

    /* =========================================================
       9. Condition of Domicile Lord
       ========================================================= */
    sec.innerHTML += `<div class="subsection"><h4>9. Condition of Domicile Lord</h4>`;
    sec.innerHTML += `
    <div class="field">
        <label>Lord‑condition</label>
        ${lordCond.map(v=>`
            <div class="inline">
                <input type="radio" id="${p.name}_lord_${v.split(' ')[0].toLowerCase()}" name="${p.name}[lord_condition]" value="${v}" required>
                <label for="${p.name}_lord_${v.split(' ')[0].toLowerCase()}">${v}</label>
            </div>`).join('')}
    </div>
    <div class="field">
        <label for="${p.name}_aversion_mitig">Aversion mitigated by sign sympathy</label>
        <input type="checkbox" id="${p.name}_aversion_mitig"
               name="${p.name}[lord_aversion_mitig]" value="yes">
    </div>`;
    sec.innerHTML += `</div>`; /* end of Condition of Domicile Lord */

    /* =========================================================
       10. Judgment (overall grade)
       ========================================================= */
    sec.innerHTML += `<div class="subsection"><h4>10. Judgment (overall grade)</h4>`;
    const grades = [
        "A+", "A", "A-",
        "B+", "B", "B-",
        "C+", "C", "C-",
        "D+", "D", "D-",
        "E+", "E", "E-",
        "F+", "F", "F-"
    ];
    sec.innerHTML += `
    <div class="field">
        <label for="${p.name}_grade">Overall grade</label>
        <select id="${p.name}_grade" name="${p.name}[grade]" required>
            <option value="">--Select Grade--</option>
            ${grades.map(g=>`<option value="${g}">${g}</option>`).join('')}
        </select>
    </div>`;
    sec.innerHTML += `</div>`; /* end of Judgment */

    container.appendChild(sec);
});
</script>

<!-- Include astronomy calculation libraries -->
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
<script type="module" id="autoCalcModule">
import { GeocodingService } from './js/geocoding-service.js';
import {
    calculatePlanetaryPositions,
    calculatePlanetaryMotion,
    calculateSect,
    longitudeToSign,
    checkCombustion,
    determineMorningEvening,
    calculateSectBeneficMalefic,
    calculateEssentialDignities,
    calculateTriplicityRuler,
    calculateAllAspects,
    calculateOverallTestimony
} from './js/astro-calculations.js';
</script>

<!-- Include the planet evaluation system -->
<script src="./js/planet_evaluation.js"></script>

<script>
/* ----------------------------------------------------
   FORM SUBMISSION & EVALUATION
   ---------------------------------------------------- */
document.getElementById('chartForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Get client name and chart sect
    const clientName = document.getElementById('b_name').value;
    const chartSect = document.querySelector('input[name="chart_sect"]:checked').value === 'day' ? 'Diurnal' : 'Nocturnal';

    // Create evaluation instance
    const evaluation = new PlanetEvaluation(clientName, chartSect);

    // Process each planet
    planets.forEach(p => {
        const planetData = extractPlanetData(p.name);
        if (planetData) {
            evaluation.addPlanet(p.name, planetData);
        }
    });

    // Calculate scores
    const scores = evaluation.calculateAllScores();

    // Display results
    displayResults(evaluation, scores);
});

/**
 * Extract planet data from form fields and convert to PlanetEvaluation format
 */
function extractPlanetData(planetName) {
    const prefix = planetName;

    // Get nature
    const natureSelect = document.getElementById(`${prefix}_nature`);
    if (!natureSelect || !natureSelect.value) return null;

    // Get sect info
    const planetSect = document.querySelector(`input[name="${prefix}[sect]"]:checked`);
    const relSect = document.querySelector(`input[name="${prefix}[rel_sect]"]:checked`);
    if (!planetSect || !relSect) return null;

    // Get rejoicing checkboxes
    const rejoicingHem = document.getElementById(`${prefix}_rejoy_hem`);
    const rejoicingSign = document.getElementById(`${prefix}_rejoy_sign`);
    const rejoicingPhase = document.getElementById(`${prefix}_rejoy_phase`);

    // Get lords (checking if they have values entered)
    const domicileLord = document.getElementById(`${prefix}_domicile`);
    const exaltLord = document.getElementById(`${prefix}_exalt`);
    const tripLord = document.getElementById(`${prefix}_trip`);
    const boundLord = document.getElementById(`${prefix}_bound`);

    // Get dignity checkboxes
    const dignityCheckboxes = document.querySelectorAll(`input[name="${prefix}[dignity][]"]:checked`);
    const dignities = Array.from(dignityCheckboxes).map(cb => cb.value);

    // Get solar phase data
    const speed = document.querySelector(`input[name="${prefix}[solar][speed]"]:checked`);
    const direction = document.querySelector(`input[name="${prefix}[solar][direction]"]:checked`);
    const visibility = document.querySelector(`input[name="${prefix}[solar][visibility]"]:checked`);
    const phase = document.querySelector(`select[name="${prefix}[solar][phase]"]`);

    if (!speed || !direction || !visibility || !phase) return null;

    // Determine visibility status for scoring
    let visibilityStatus = 'Visible';
    if (visibility.value.includes('Under Beams')) {
        // Check for cazimi
        const cazimi = document.getElementById(`${prefix}_cazimi`);
        if (cazimi && cazimi.checked) {
            visibilityStatus = 'Cazimi';
        } else {
            visibilityStatus = 'Combust';
        }
    }

    // Get lunar aspects
    const moonApplying = document.getElementById(`${prefix}_moon_applying`);
    const conjNode = document.getElementById(`${prefix}_conj_node`);

    // Get testimony
    const favorableTestimony = document.getElementById(`${prefix}_testimony_favorable`);
    const unfavorableTestimony = document.getElementById(`${prefix}_testimony_unfavorable`);

    // Get condition
    const condition = document.querySelector(`input[name="${prefix}[condition]"]:checked`);
    if (!condition) return null;

    // Get lord condition
    const lordCond = document.querySelector(`input[name="${prefix}[lord_condition]"]:checked`);
    if (!lordCond) return null;

    // Build the data object in PlanetEvaluation format
    return {
        nature: natureSelect.value,
        sect: {
            dayNight: planetSect.value,
            sameContrary: relSect.value === 'same' ? 'Same' : 'Contrary'
        },
        rejoicing: {
            hemisphere: rejoicingHem ? (rejoicingHem.checked ? 'Yes' : 'No') : 'N/A',
            sign: rejoicingSign ? (rejoicingSign.checked ? 'Yes' : 'No') : 'N/A',
            solarPhase: rejoicingPhase ? (rejoicingPhase.checked ? 'Yes' : 'No') : 'N/A'
        },
        lords: {
            domicile: domicileLord && domicileLord.value ? 'Yes' : 'No',
            exaltation: exaltLord && exaltLord.value ? 'Yes' : 'No',
            triplicity: tripLord && tripLord.value ? 'Yes' : 'No',
            bound: boundLord && boundLord.value ? 'Yes' : 'No'
        },
        essentialDignity: {
            domicile: dignities.includes('Domicile') ? 'Yes' : 'No',
            detriment: dignities.includes('Detriment') ? 'Yes' : 'No',
            exaltation: dignities.includes('Exaltation') ? 'Yes' : 'No',
            fall: dignities.includes('Fall') ? 'Yes' : 'No',
            triplicity: 'No', // Not captured separately in form
            bound: 'No', // Not captured separately in form
            mutualReception: dignities.includes('Mutual Reception') ? 'Yes' : 'No'
        },
        solarPhase: {
            speed: speed.value,
            direction: direction.value,
            station: 'Not Stationary', // Could be enhanced
            visibility: visibilityStatus,
            morningEvening: phase.value.includes('morning') ? 'Morning' :
                          phase.value.includes('evening') ? 'Evening' : 'None',
            phasis: 'No' // Could be enhanced from phase transition checkboxes
        },
        lunarAspects: {
            lunarApplication: moonApplying && moonApplying.checked ? 'Applying' : 'No',
            nodalConnection: conjNode && conjNode.checked ? 'Yes' : 'None'
        },
        testimony: {
            favorable: favorableTestimony && favorableTestimony.checked ? 'Yes' : 'No',
            unfavorable: unfavorableTestimony && unfavorableTestimony.checked ? 'Yes' : 'No',
            maltreated: condition.value === 'Maltreated' ? 'Yes' : 'No',
            bonified: condition.value === 'Bonified' ? 'Yes' : 'No'
        },
        conditionOfDomicileLord: lordCond.value.includes('Helped') ? 'Helps' : 'Hinders',
        judgmentGrade: document.getElementById(`${prefix}_grade`).value
    };
}

/**
 * Display the evaluation results
 */
function displayResults(evaluation, scores) {
    const resultsDiv = document.getElementById('results');
    const contentDiv = document.getElementById('resultsContent');

    let html = `
        <div style="margin-bottom:2rem;">
            <h3>Client: ${evaluation.clientName}</h3>
            <p><strong>Chart Sect:</strong> ${evaluation.chartSect}</p>
        </div>
    `;

    // Display each planet's score
    for (const planetName in scores) {
        const score = scores[planetName];
        if (!score) continue;

        const gradeClass = `grade-${score.grade}`;

        html += `
            <div class="result-planet">
                <h3>${planetName}</h3>
                <div class="grade ${gradeClass}">${score.grade}</div>
                <p><strong>Raw Score:</strong> ${score.rawScore}</p>
                <p><strong>Normalized Score:</strong> ${score.normalizedScore.toFixed(1)}/100</p>

                <div class="factors">
                    <h4>Scoring Factors:</h4>
                    <ul>
                        ${score.factors.map(f => `<li>${f}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    }

    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';

    // Scroll to results
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>

</body>
</html>
